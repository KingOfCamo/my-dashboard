<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitness Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
:root {
  --bg-primary: #0a0c10;
  --bg-card: rgba(22, 25, 35, 0.7);
  --bg-card-hover: rgba(30, 34, 48, 0.85);
  --border: rgba(255, 255, 255, 0.06);
  --border-hover: rgba(108, 159, 255, 0.3);
  --text-primary: #e8eaed;
  --text-secondary: #9aa0a6;
  --text-muted: #5f6368;
  --accent: #6c9fff;
  --accent-secondary: #bb86fc;
  --accent-glow: rgba(108, 159, 255, 0.15);
  --green: #34d399;
  --orange: #fb923c;
  --red: #f87171;
  --yellow: #fbbf24;
  --radius: 16px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 40px rgba(108, 159, 255, 0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  padding: 16px;
  -webkit-font-smoothing: antialiased;
  background-image:
    radial-gradient(ellipse 80% 50% at 50% -20%, rgba(108, 159, 255, 0.08), transparent),
    radial-gradient(ellipse 60% 40% at 80% 100%, rgba(187, 134, 252, 0.06), transparent);
}

.loading-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 80vh;
  gap: 20px;
}

.spinner {
  width: 48px; height: 48px;
  border: 3px solid transparent;
  border-top-color: var(--accent);
  border-right-color: var(--accent-secondary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  box-shadow: 0 0 20px rgba(108, 159, 255, 0.15);
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-screen p { color: var(--text-secondary); font-size: 14px; letter-spacing: 0.3px; }

.error-banner {
  background: rgba(248,113,113,0.1);
  border: 1px solid var(--red);
  color: var(--red);
  padding: 12px 16px;
  border-radius: var(--radius);
  margin-bottom: 16px;
  font-size: 14px;
}

header {
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

header h1 {
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 10px;
  letter-spacing: -0.5px;
  background: linear-gradient(135deg, var(--accent), var(--accent-secondary), var(--accent));
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
  0%, 100% { background-position: 0% center; }
  50% { background-position: 200% center; }
}

.header-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.header-stat {
  font-size: 13px;
  color: var(--text-secondary);
}

.header-stat strong {
  color: var(--text-primary);
}

.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(52,211,153,0.12);
  color: var(--green);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  border: 1px solid rgba(52,211,153,0.2);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(52,211,153,0.15); }
  50% { box-shadow: 0 0 12px 4px rgba(52,211,153,0.1); }
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

@media (min-width: 768px) {
  body { padding: 24px 32px; }
  .grid { grid-template-columns: 1fr 1fr; }
  .grid .full-width { grid-column: 1 / -1; }
}

@media (min-width: 1200px) {
  body { padding: 32px 48px; max-width: 1400px; margin: 0 auto; }
}

.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  box-shadow: var(--shadow);
}

.card h2 {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 16px;
}

.card .chart-container {
  position: relative;
  width: 100%;
}

.card select {
  background: rgba(15, 17, 23, 0.6);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  font-size: 14px;
  margin-bottom: 12px;
  width: 100%;
  max-width: 320px;
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239aa0a6' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  transition: all 0.25s ease;
}

.card select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(108, 159, 255, 0.1);
}

.recommendations {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.rec-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 16px;
  background: rgba(15, 17, 23, 0.5);
  border: 1px solid var(--border);
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.6;
}

.rec-icon {
  flex-shrink: 0;
  width: 32px;
  height: 32px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
}

.rec-icon.warn { background: rgba(251,146,60,0.15); color: var(--orange); }
.rec-icon.info { background: rgba(108,159,255,0.15); color: var(--accent); }
.rec-icon.good { background: rgba(52,211,153,0.15); color: var(--green); }

.summary-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

@media (min-width: 768px) {
  .summary-grid { grid-template-columns: repeat(4, 1fr); }
}

.summary-item {
  background: rgba(15, 17, 23, 0.6);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 18px 14px;
  text-align: center;
}

.summary-item .value {
  font-size: 32px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.2;
}

.summary-item .label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-top: 6px;
  font-weight: 600;
}

.no-data {
  color: var(--text-muted);
  font-size: 13px;
  text-align: center;
  padding: 40px 0;
}

/* Log Workout Form */
.log-form-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

@media (max-width: 767px) {
  .log-form-row { grid-template-columns: 1fr; }
}

.log-field label {
  display: block;
  font-size: 11px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.log-field input,
.log-field select {
  background: rgba(15, 17, 23, 0.6);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  font-size: 14px;
  width: 100%;
  transition: all 0.25s ease;
}

.log-field input:focus,
.log-field select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(108, 159, 255, 0.1);
}

/* Fix date input color scheme for dark mode */
.log-field input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(0.7);
}

.log-exercises {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.log-exercise-row {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  padding: 12px 14px;
  background: rgba(15, 17, 23, 0.35);
  border: 1px solid var(--border);
  border-radius: 12px;
  transition: border-color 0.25s ease;
}

.log-exercise-row:hover {
  border-color: rgba(108, 159, 255, 0.15);
}

.log-exercise-row label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.log-exercise-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr auto;
  gap: 8px;
  align-items: end;
}

@media (max-width: 767px) {
  .log-exercise-inputs {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .log-exercise-inputs .each-side-toggle {
    grid-column: 1 / -1;
  }
}

.log-exercise-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.log-exercise-field .field-label {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.log-exercise-row input {
  background: rgba(15, 17, 23, 0.6);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 9px 10px;
  font-size: 14px;
  width: 100%;
  min-width: 0;
  transition: all 0.25s ease;
  text-align: center;
}

.log-exercise-row input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(108, 159, 255, 0.1);
}

/* Remove number input spinners for cleaner look */
.log-exercise-row input[type="number"]::-webkit-inner-spin-button,
.log-exercise-row input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.log-exercise-row input[type="number"] {
  -moz-appearance: textfield;
}

.each-side-toggle {
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
  padding: 9px 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: transparent;
  white-space: nowrap;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 600;
  align-self: end;
}

.each-side-toggle:hover {
  border-color: rgba(108,159,255,0.3);
  color: var(--text-secondary);
}

.each-side-toggle.active {
  color: var(--accent);
  border-color: var(--accent);
  background: rgba(108,159,255,0.12);
  box-shadow: 0 0 12px rgba(108,159,255,0.15);
}

.log-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
  color: white;
  border: none;
  border-radius: 10px;
  padding: 12px 36px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  min-height: 44px;
  box-shadow: 0 4px 15px rgba(108, 159, 255, 0.25);
  letter-spacing: 0.3px;
}

.log-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(108, 159, 255, 0.35);
}

.log-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(108, 159, 255, 0.2);
}

.log-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

.log-status {
  margin-top: 12px;
  font-size: 13px;
  min-height: 20px;
}

.log-status.success { color: var(--green); }
.log-status.error { color: var(--red); }

/* Collapsible Log Workout */
.log-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}

.log-toggle-icon {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: rgba(108, 159, 255, 0.1);
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: transform 0.3s ease, background 0.2s;
}

.log-toggle:hover .log-toggle-icon {
  background: rgba(108, 159, 255, 0.2);
}

.log-toggle-icon.open {
  transform: rotate(180deg);
}

.log-form-wrapper {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
  opacity: 0;
}

.log-form-wrapper.open {
  max-height: 800px;
  opacity: 1;
}

/* Smooth scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

/* Focus ring for accessibility */
select:focus, input:focus, button:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Exercise Technique Modal */
.exercise-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.exercise-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
}

.exercise-modal-content {
  position: relative;
  background: rgba(22, 25, 35, 0.95);
  border: 1px solid rgba(108, 159, 255, 0.15);
  border-radius: 20px;
  box-shadow: 0 8px 48px rgba(0, 0, 0, 0.6), 0 0 60px rgba(108, 159, 255, 0.06);
  max-width: 560px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 28px;
  animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalSlideIn {
  from { opacity: 0; transform: translateY(20px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.exercise-modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  color: var(--text-secondary);
  font-size: 28px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.15s, color 0.15s;
}

.exercise-modal-close:hover {
  background: var(--bg-primary);
  color: var(--text-primary);
}

.exercise-modal-header h3 {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 4px;
  padding-right: 36px;
}

.exercise-modal-muscle {
  display: inline-block;
  font-size: 12px;
  color: var(--accent);
  background: rgba(108, 159, 255, 0.12);
  padding: 2px 10px;
  border-radius: 20px;
  font-weight: 600;
  margin-bottom: 16px;
}

.exercise-modal-video-container {
  width: 100%;
  background: var(--bg-primary);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 20px;
  position: relative;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
}

.exercise-modal-video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
}

.exercise-modal-video-container .exercise-modal-gif-placeholder {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.exercise-modal-gif-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 40px;
  color: var(--text-muted);
  font-size: 13px;
}

.exercise-modal-section {
  margin-bottom: 16px;
}

.exercise-modal-section h4 {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.exercise-modal-section p {
  font-size: 14px;
  color: var(--text-primary);
  line-height: 1.5;
}

.exercise-modal-section ol,
.exercise-modal-section ul {
  padding-left: 20px;
  font-size: 13px;
  color: var(--text-primary);
  line-height: 1.7;
}

.exercise-modal-section ol li,
.exercise-modal-section ul li {
  margin-bottom: 4px;
}

.exercise-modal-section ul li {
  color: var(--orange);
}

/* Clickable exercise name styling */
.exercise-link {
  cursor: pointer;
  text-decoration: underline;
  text-decoration-color: var(--text-muted);
  text-decoration-style: dotted;
  text-underline-offset: 3px;
  transition: color 0.15s, text-decoration-color 0.15s;
}

.exercise-link:hover {
  color: var(--accent);
  text-decoration-color: var(--accent);
}

/* Exercise info button next to dropdown */
.exercise-info-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--accent);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 18px;
  cursor: pointer;
  flex-shrink: 0;
  transition: background 0.15s;
}

.exercise-info-btn:hover {
  background: rgba(108,159,255,0.1);
}

@media (max-width: 767px) {
  .exercise-modal-content {
    max-height: 90vh;
    padding: 16px;
  }
  .exercise-modal-header h3 {
    font-size: 18px;
  }
}
</style>
</head>
<body>

<div id="loading" class="loading-screen">
  <div class="spinner"></div>
  <p>Loading workout data...</p>
</div>

<div id="app" style="display:none">
  <header>
    <h1>Fitness Dashboard</h1>
    <div class="header-stats" id="header-stats"></div>
  </header>

  <div class="grid">
    <div class="card full-width" id="log-card">
      <div class="log-toggle" id="log-toggle">
        <h2 style="margin-bottom:0">Log Workout</h2>
        <div class="log-toggle-icon" id="log-toggle-icon">&#9660;</div>
      </div>
      <div class="log-form-wrapper" id="log-form-wrapper">
      <form id="log-form" style="padding-top:16px">
        <div class="log-form-row">
          <div class="log-field">
            <label for="log-type">Workout Type</label>
            <select id="log-type"></select>
          </div>
          <div class="log-field">
            <label for="log-date">Date</label>
            <input type="date" id="log-date">
          </div>
          <div class="log-field">
            <label for="log-bodyweight">Body Weight (kg)</label>
            <input type="text" id="log-bodyweight" placeholder="e.g. 72.5">
          </div>
        </div>
        <div id="log-exercises" class="log-exercises"></div>
        <button type="submit" id="log-submit" class="log-btn">Log Workout</button>
        <div id="log-status" class="log-status"></div>
      </form>
      </div>
    </div>

    <div class="card full-width" id="summary-card">
      <h2>Overview</h2>
      <div class="summary-grid" id="summary-grid"></div>
    </div>

    <div class="card">
      <h2>Exercise Progress</h2>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
        <select id="exercise-select"></select>
        <button id="exercise-info-btn" class="exercise-info-btn" title="View technique">&#9432;</button>
      </div>
      <div class="chart-container"><canvas id="exerciseChart"></canvas></div>
    </div>

    <div class="card">
      <h2>Muscle Group Balance</h2>
      <div class="chart-container"><canvas id="muscleChart"></canvas></div>
    </div>

    <div class="card">
      <h2>Body Weight</h2>
      <div class="chart-container"><canvas id="weightChart"></canvas></div>
    </div>

    <div class="card">
      <h2>Workout Frequency (per week)</h2>
      <div class="chart-container"><canvas id="frequencyChart"></canvas></div>
    </div>

    <div class="card full-width">
      <h2>Training Recommendations</h2>
      <div class="recommendations" id="recommendations"></div>
    </div>
  </div>
</div>

<!-- Exercise Technique Modal -->
<div id="exercise-modal" class="exercise-modal" style="display:none" role="dialog" aria-modal="true">
  <div class="exercise-modal-backdrop"></div>
  <div class="exercise-modal-content">
    <button class="exercise-modal-close" aria-label="Close">&times;</button>
    <div class="exercise-modal-header">
      <h3 id="exercise-modal-title"></h3>
      <span class="exercise-modal-muscle" id="exercise-modal-muscle"></span>
    </div>
    <div class="exercise-modal-body">
      <div class="exercise-modal-video-container" id="exercise-modal-video-container">
        <iframe id="exercise-modal-video" src="" frameborder="0" allowfullscreen
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
        <div id="exercise-modal-video-placeholder" class="exercise-modal-gif-placeholder">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="5" r="3"/>
            <path d="M12 8v8M8 12h8M9 20l3-4 3 4"/>
          </svg>
          <span>Video not available</span>
        </div>
      </div>
      <div class="exercise-modal-details">
        <div class="exercise-modal-section">
          <h4>Equipment</h4>
          <p id="exercise-modal-equipment"></p>
        </div>
        <div class="exercise-modal-section">
          <h4>Technique Cues</h4>
          <ol id="exercise-modal-cues"></ol>
        </div>
        <div class="exercise-modal-section">
          <h4>Common Mistakes</h4>
          <ul id="exercise-modal-mistakes"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const SHEET_ID = '1-90RuZhoTEBevAUqphehDaOtimhbIyPy63nRTEAwmlQ';
const SHEETS = ['Workout 2025', 'Workout 2026'];

// Apps Script web app URL — paste your deployment URL here
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw452wMFW4Otb7kGovuKhEUKJeD0MbYc6etQ_DxtOyqdhvENe9wu-d71BcDQbjaCIA4-Q/exec';

// Workout types and their exercises (must match column A in the Google Sheet exactly)
const WORKOUT_TYPES = {
  'Chest + Tris Workout': [
    'Dumbbell press',
    'Dumbbell incline',
    'Cable press',
    'Tri Pushdown (Cable)',
    'Lat Raises',
    'Dips',
    'Steel tri bar',
  ],
  'Back & Biceps': [
    'Hammer Curls',
    'Cable curl straight bar',
    'Seated Rows',
    'Lat Pull Down',
    'Lat Pull down (Close Grip)',
    'Pull Ups',
  ],
};

// ============================================================
// MUSCLE GROUP MAPPING
// ============================================================
const MUSCLE_MAP = {
  'dumbbell press': 'Chest',
  'dumbbell incline': 'Chest',
  'cable press': 'Chest',
  'chest press': 'Chest',
  'chest up': 'Chest',
  'cable fly': 'Chest',
  'fly': 'Chest',
  'bench press': 'Chest',
  'incline press': 'Chest',
  'tri pushdown': 'Triceps',
  'tri pull down rope': 'Triceps',
  'tri on knees': 'Triceps',
  'tricep': 'Triceps',
  'skull crushers': 'Triceps',
  'overhead tri': 'Triceps',
  'steel tri bar': 'Triceps',
  'dips': 'Chest',
  'lat raises': 'Shoulders',
  'lateral raises': 'Shoulders',
  'shoulder press': 'Shoulders',
  'ohp': 'Shoulders',
  'face pulls': 'Shoulders',
  'leg press': 'Legs',
  'lunges': 'Legs',
  'calf raises': 'Legs',
  'squats': 'Legs',
  'squat': 'Legs',
  'leg curl': 'Legs',
  'leg extension': 'Legs',
  'hamstring': 'Legs',
  'rdl': 'Legs',
  'deadlift': 'Legs',
  'hip thrust': 'Legs',
  'seated rows': 'Back',
  'seated row': 'Back',
  'lat pull down': 'Back',
  'lat pulldown': 'Back',
  'lay pull down': 'Back',
  'pull ups': 'Back',
  'pull-ups': 'Back',
  'chin ups': 'Back',
  'rows': 'Back',
  'barbell row': 'Back',
  'cable row': 'Back',
  't-bar row': 'Back',
  'back extension': 'Back',
  'bar to chest': 'Back',
  'knee up core': 'Core',
  'knee up': 'Core',
  'knee raises': 'Core',
  'core': 'Core',
  'abs': 'Core',
  'plank': 'Core',
  'elbow plank': 'Core',
  'side arm plank': 'Core',
  'bicycle': 'Core',
  'superman': 'Core',
  'bicep curl': 'Biceps',
  'curls': 'Biceps',
  'hammer curl': 'Biceps',
  'preacher curl': 'Biceps',
  'cable curl': 'Biceps',
};

// ============================================================
// EXERCISE TECHNIQUE REFERENCE
// ============================================================
const EXERCISE_REFERENCE = {
  'dumbbell press': {
    displayName: 'Dumbbell Press',
    videoId: 'dGqI0Z5ul4k',
    videoPlatform: 'youtube',
    muscleGroup: 'Chest',
    equipment: 'Dumbbells, Flat Bench',
    cues: [
      'Lie flat on bench with feet firmly on the floor',
      'Hold dumbbells at chest level, palms facing forward',
      'Press up in a slight arc, bringing dumbbells together at the top',
      'Lower with control, elbows at roughly 45 degrees to torso',
      'Keep shoulder blades retracted and squeezed together throughout',
    ],
    common_mistakes: [
      'Flaring elbows to 90 degrees (increases shoulder impingement risk)',
      'Bouncing the weight off the chest',
      'Arching the lower back excessively',
    ],
  },
  'dumbbell incline': {
    displayName: 'Dumbbell Incline Press',
    videoId: '8nNi8jbbUPE',
    videoPlatform: 'youtube',
    muscleGroup: 'Chest (Upper)',
    equipment: 'Dumbbells, Incline Bench (30-45 degrees)',
    cues: [
      'Set bench to 30-45 degree incline',
      'Press dumbbells from chest level upward and slightly back',
      'Keep wrists stacked over elbows throughout the movement',
      'Lower until dumbbells are level with upper chest',
      'Drive feet into the floor for stability',
    ],
    common_mistakes: [
      'Setting incline too steep (turns it into a shoulder press)',
      'Letting wrists roll backward',
    ],
  },
  'cable press': {
    displayName: 'Cable Press',
    videoId: 'n4CEULDvATA',
    videoPlatform: 'youtube',
    muscleGroup: 'Chest',
    equipment: 'Cable Machine',
    cues: [
      'Set cables at chest height or slightly above',
      'Step forward into a split stance for stability',
      'Press handles forward and together in a hugging motion',
      'Squeeze chest hard at the fully extended position',
      'Return slowly, feeling the stretch across the chest',
    ],
    common_mistakes: [
      'Using too much body momentum to press',
      'Not controlling the eccentric (return) phase',
    ],
  },
  'tri pushdown (cable)': {
    displayName: 'Tricep Pushdown (Cable)',
    videoId: 'mpZ9VRisAyw',
    videoPlatform: 'youtube',
    muscleGroup: 'Triceps',
    equipment: 'Cable Machine, Straight or V-Bar',
    cues: [
      'Stand tall with elbows pinned to your sides',
      'Push the bar down by extending your elbows fully',
      'Squeeze the triceps hard at the bottom',
      'Return slowly, stopping when forearms are parallel to the floor',
      'Keep your torso upright — do not lean over the bar',
    ],
    common_mistakes: [
      'Letting elbows drift forward or flare out',
      'Using shoulder momentum to push the weight down',
    ],
  },
  'lat raises': {
    displayName: 'Lateral Raises',
    videoId: '3VcKaXpzqRo',
    videoPlatform: 'youtube',
    muscleGroup: 'Shoulders (Side Delts)',
    equipment: 'Dumbbells',
    cues: [
      'Stand with dumbbells at your sides, slight bend in elbows',
      'Raise arms out to the sides until parallel with the floor',
      'Lead with your elbows, not your hands',
      'Slight forward lean and pour as if pouring water at the top',
      'Lower with control — do not just drop the weight',
    ],
    common_mistakes: [
      'Using momentum to swing the weight up',
      'Shrugging the traps during the movement',
      'Going too heavy and losing form',
    ],
  },
  'dips': {
    displayName: 'Dips',
    videoId: 'FG1ENBFsdHU',
    videoPlatform: 'youtube',
    muscleGroup: 'Chest / Triceps',
    equipment: 'Dip Station or Parallel Bars',
    cues: [
      'Grip bars slightly wider than shoulder width',
      'Lean torso slightly forward for chest emphasis',
      'Lower until upper arms are parallel to the floor',
      'Press up by extending elbows fully',
      'Keep shoulders down and away from ears',
    ],
    common_mistakes: [
      'Going too deep (excessive shoulder stress)',
      'Staying too upright (shifts load entirely to triceps if chest is the target)',
    ],
  },
  'steel tri bar': {
    displayName: 'Steel Tri Bar (Tricep Extension)',
    videoId: 'K6MSN4hCDM4',
    videoPlatform: 'youtube',
    muscleGroup: 'Triceps',
    equipment: 'Steel Tri Bar / EZ Curl Bar',
    cues: [
      'Grip the bar with a narrow, neutral or close grip',
      'Keep elbows pointing forward and close together',
      'Extend the bar overhead or forward by straightening the arms',
      'Control the lowering phase, feeling the stretch in the triceps',
      'Do not let elbows flare wide',
    ],
    common_mistakes: [
      'Flaring elbows outward',
      'Using back or shoulder momentum',
    ],
  },
  'hammer curls': {
    displayName: 'Hammer Curls',
    videoId: 'TwD-YGVP4Bk',
    videoPlatform: 'youtube',
    muscleGroup: 'Biceps / Brachioradialis',
    equipment: 'Dumbbells',
    cues: [
      'Hold dumbbells with a neutral grip (palms facing each other)',
      'Curl up while keeping palms facing inward the entire time',
      'Squeeze at the top, keeping elbows stationary at your sides',
      'Lower with control — no swinging',
      'Can be done alternating or simultaneously',
    ],
    common_mistakes: [
      'Swinging the body to generate momentum',
      'Rotating the wrist during the curl (turns it into a regular curl)',
    ],
  },
  'cable curl straight bar': {
    displayName: 'Cable Curl (Straight Bar)',
    videoId: 'NFzTWp2qpiE',
    videoPlatform: 'youtube',
    muscleGroup: 'Biceps',
    equipment: 'Cable Machine, Straight Bar Attachment',
    cues: [
      'Stand facing the cable with bar at low pulley',
      'Grip bar shoulder width, palms facing up',
      'Curl the bar up by flexing at the elbows only',
      'Squeeze the biceps at the top',
      'Lower slowly, maintaining tension throughout',
    ],
    common_mistakes: [
      'Leaning back to lift the weight',
      'Allowing elbows to drift forward',
    ],
  },
  'seated rows': {
    displayName: 'Seated Rows',
    videoId: 'UCXxvVItLoM',
    videoPlatform: 'youtube',
    muscleGroup: 'Back (Mid-Back, Lats)',
    equipment: 'Cable Row Machine',
    cues: [
      'Sit upright with slight bend in knees, feet on platform',
      'Pull the handle toward your lower chest / upper abdomen',
      'Drive elbows straight back, squeezing shoulder blades together',
      'Hold the contraction for a beat at the end of the pull',
      'Return slowly, letting shoulders protract slightly for a stretch',
    ],
    common_mistakes: [
      'Rounding the back during the pull',
      'Using excessive body lean (rowing with momentum)',
    ],
  },
  'lat pull down': {
    displayName: 'Lat Pulldown',
    videoId: 'iKrKgWR9wbY',
    videoPlatform: 'youtube',
    muscleGroup: 'Back (Lats)',
    equipment: 'Lat Pulldown Machine',
    cues: [
      'Grip the bar slightly wider than shoulder width',
      'Lean back slightly and pull the bar to your upper chest',
      'Drive elbows down and back, squeezing the lats',
      'Control the bar back up, fully extending the arms',
      'Keep chest up and avoid rounding forward',
    ],
    common_mistakes: [
      'Pulling behind the neck (shoulder injury risk)',
      'Leaning too far back (turns into a row)',
      'Using grip/biceps instead of initiating with lats',
    ],
  },
  'lat pull down (close grip)': {
    displayName: 'Lat Pulldown (Close Grip)',
    videoId: 'uAyrz5GTEHg',
    videoPlatform: 'youtube',
    muscleGroup: 'Back (Lats, Lower Lats)',
    equipment: 'Lat Pulldown Machine, V-Bar or Close Grip Handle',
    cues: [
      'Use a V-bar or narrow handle attachment',
      'Pull down to chest level, elbows driving toward hips',
      'Squeeze at the bottom, emphasizing the lower lat contraction',
      'Return slowly with full arm extension at the top',
      'Keep torso stable with a slight backward lean',
    ],
    common_mistakes: [
      'Excessive body swing',
      'Not achieving full range of motion at the top',
    ],
  },
  'pull ups': {
    displayName: 'Pull Ups',
    videoId: 'poyr8KenUfc',
    videoPlatform: 'youtube',
    muscleGroup: 'Back (Lats, Upper Back)',
    equipment: 'Pull Up Bar',
    cues: [
      'Hang with arms fully extended, palms facing away (overhand grip)',
      'Pull up by driving elbows down toward your hips',
      'Get chin above the bar at the top',
      'Lower with control to a full dead hang',
      'Avoid kipping or swinging for strict pull ups',
    ],
    common_mistakes: [
      'Half-reps (not going to full extension at bottom)',
      'Excessive kipping or swinging',
      'Craning the neck to get chin over bar',
    ],
  },
};

function getExerciseReference(exerciseName) {
  const lower = exerciseName.toLowerCase().trim();
  if (EXERCISE_REFERENCE[lower]) return EXERCISE_REFERENCE[lower];
  for (const [key, ref] of Object.entries(EXERCISE_REFERENCE)) {
    if (lower.includes(key) || key.includes(lower)) return ref;
  }
  return null;
}

function classifyExercise(name) {
  const lower = name.toLowerCase().trim();
  // Exact match first
  if (MUSCLE_MAP[lower]) return MUSCLE_MAP[lower];
  // Partial match — check if exercise name contains a key or key contains exercise name
  for (const [key, group] of Object.entries(MUSCLE_MAP)) {
    if (lower.includes(key) || key.includes(lower)) return group;
  }
  return 'Other';
}

// ============================================================
// DATE PARSER — handles all the wild formats in the sheet
// ============================================================
const MONTHS = {
  january:0,february:1,march:2,april:3,may:4,june:5,
  july:6,august:7,september:8,october:9,november:10,december:11,
  jan:0,feb:1,mar:2,apr:3,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11
};

function parseDate(str) {
  if (!str) return null;
  // Strip day names and "the" prefix: "Wednesday the 05/02/2020" → "05/02/2020"
  let s = str.trim()
    .replace(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\s*/i, '')
    .replace(/^the\s+/i, '')
    .trim();
  if (!s) return null;

  let m;

  // "8 November 2025" or "4 January 2026" — D(D) Month YYYY
  m = s.match(/^(\d{1,2})\s+([a-z]+)\s+(\d{4})$/i);
  if (m) {
    const mon = MONTHS[m[2].toLowerCase()];
    if (mon !== undefined) return new Date(+m[3], mon, +m[1]);
  }

  // "November 2025" — Month YYYY (no day, skip)

  // DD/MM/YYYY or DD/MM/YY
  m = s.match(/^(\d{1,2})[/\-.](\d{1,2})[/\-.](\d{2,4})$/);
  if (m) {
    let year = +m[3];
    if (year < 100) year += 2000;
    // Assume DD/MM/YYYY (Ben is Australian)
    return new Date(year, +m[2] - 1, +m[1]);
  }

  // DD/MM (no year) — e.g. "26/3"
  m = s.match(/^(\d{1,2})[/\-.](\d{1,2})$/);
  if (m) {
    // No year — we'll need context. Default to 2025 as a heuristic for the "Chest + Tris" sheet
    // But actually these appear in a sheet context, so we'll handle fallback year outside
    return new Date(2025, +m[2] - 1, +m[1]);
  }

  // YYYY-MM-DD
  m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (m) return new Date(+m[1], +m[2] - 1, +m[3]);

  // Try native Date parsing as last resort (handles "Saturday 8 November 2025" etc.)
  const d = new Date(str.trim());
  if (!isNaN(d.getTime()) && d.getFullYear() > 2000) return d;

  return null;
}

// ============================================================
// PARSER — handles free-text workout notation
// ============================================================
function parseWorkoutCell(text) {
  if (!text || typeof text !== 'string') return [];
  const trimmed = text.trim();
  if (!trimmed) return [];
  // Skip non-data values
  if (/^(n\/a|—|–|-|not yet|did not do|rest|off|x|free weight|\d+r|\d+\s*minute|\d+\s*seconds?)$/i.test(trimmed)) return [];
  // Skip URLs and notes
  if (trimmed.startsWith('http') || trimmed.startsWith('NOTE')) return [];

  const results = [];
  // Split on comma or "&" for compound entries
  // "2s of 12r @ 10kg, 1s of 12r @ 12.5kg"
  // "1s of 8r @ 17.5kgs each side & 2s of 8r @ 15kgs each side."
  const segments = trimmed.split(/,\s*|\s*&\s*/);

  for (const seg of segments) {
    const parsed = parseSegment(seg.trim());
    if (parsed) results.push(parsed);
  }
  return results;
}

function parseSegment(text) {
  if (!text) return null;

  // Strip trailing notes: exercise name echoes, "each side", "on machine", parens, periods
  let clean = text
    .replace(/\s*(dumbbell press|dumbbell incline|cable press).*$/i, '')
    .replace(/\.\s*$/, '')
    .trim();

  let m;

  // Primary pattern: "3s of 10r @ 12kgs" or "3s of 12r @ 12.5kg"
  // Also handles trailing notes like "each side", "(+Bar)", "on machine (÷2)"
  m = clean.match(/(\d+)\s*s\s+of\s+(\d+)\s*r\s*@\s*([\d.]+)\s*(?:kgs?|lbs?|pounds?)?/i);
  if (m) return { sets: +m[1], reps: +m[2], weight: +m[3] };

  // Reversed pattern: "1s 12.5kgs, 2s of 10kgs @ 12r" or "3s of 7.9kgs @ 12r"
  m = clean.match(/(\d+)\s*s\s+(?:of\s+)?([\d.]+)\s*(?:kgs?|lbs?)\s*@\s*(\d+)\s*r/i);
  if (m) return { sets: +m[1], reps: +m[3], weight: +m[2] };

  // Reversed: "2s of 12.5kgs of 8r" — seen in the data
  m = clean.match(/(\d+)\s*s\s+(?:of\s+)?([\d.]+)\s*(?:kgs?|lbs?)\s+(?:of\s+)?(\d+)\s*r/i);
  if (m) return { sets: +m[1], reps: +m[3], weight: +m[2] };

  // Pattern without "of": "1s 12.5kgs" — weight only, assume context reps
  m = clean.match(/^(\d+)\s*s\s+([\d.]+)\s*(?:kgs?|lbs?)$/i);
  if (m) return { sets: +m[1], reps: 8, weight: +m[2] };

  // "3s of 12r @ smith machine + 10kgs each side" — extract the kg number
  m = clean.match(/(\d+)\s*s\s+of\s+(\d+)\s*r\s*@\s*.*?([\d.]+)\s*(?:kgs?|lbs?)/i);
  if (m) return { sets: +m[1], reps: +m[2], weight: +m[3] };

  // "3x10 @ 12kg" or "3x10@12"
  m = clean.match(/(\d+)\s*[x×]\s*(\d+)\s*@\s*([\d.]+)\s*(?:kgs?|lbs?)?/i);
  if (m) return { sets: +m[1], reps: +m[2], weight: +m[3] };

  // Just sets and reps with @ but no unit number recognized — "3s of 12r @ 50 plates"
  m = clean.match(/(\d+)\s*s\s+of\s+(\d+)\s*r\s*@\s*([\d.]+)\s*(?:plate|plates)/i);
  if (m) return { sets: +m[1], reps: +m[2], weight: +m[3] };

  // Just sets and reps, no weight: "3s of 10r" or "4s of 15r"
  m = clean.match(/(\d+)\s*s\s+of\s+(\d+)\s*r/i);
  if (m) return { sets: +m[1], reps: +m[2], weight: 0 };

  // "3x10" with no weight
  m = clean.match(/(\d+)\s*[x×]\s*(\d+)/i);
  if (m) return { sets: +m[1], reps: +m[2], weight: 0 };

  // Single number reps only: "20r"
  m = clean.match(/^(\d+)\s*r$/i);
  if (m) return { sets: 1, reps: +m[1], weight: 0 };

  return null;
}

// ============================================================
// WEIGHT VALUE PARSER — "71.6kgs no shoes" → 71.6
// ============================================================
function parseWeightValue(text) {
  if (!text) return null;
  const m = text.match(/([\d.]+)\s*(?:kgs?|lbs?)?/i);
  if (m) {
    const v = parseFloat(m[1]);
    if (!isNaN(v) && v > 30 && v < 200) return v; // reasonable body weight range
  }
  return null;
}

// ============================================================
// CSV PARSER
// ============================================================
function parseCSVRows(text) {
  const rows = [];
  let row = [];
  let cell = '';
  let inQuotes = false;
  const len = text.length;

  for (let i = 0; i < len; i++) {
    const ch = text[i];
    if (inQuotes) {
      if (ch === '"') {
        if (text[i + 1] === '"') {
          cell += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        cell += ch;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ',') {
        row.push(cell);
        cell = '';
      } else if (ch === '\r' || ch === '\n') {
        if (ch === '\r' && text[i + 1] === '\n') i++;
        row.push(cell);
        cell = '';
        if (row.some(c => c.trim() !== '')) rows.push(row);
        row = [];
      } else {
        cell += ch;
      }
    }
  }
  // Last row
  row.push(cell);
  if (row.some(c => c.trim() !== '')) rows.push(row);

  return rows;
}

// ============================================================
// DATA FETCHER
// ============================================================
async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Failed to fetch sheet "${sheetName}": ${res.status}`);
  const text = await res.text();
  return parseCSVRows(text);
}

// ============================================================
// TRANSPOSE & NORMALIZE — handles multi-section sheets
// ============================================================
function isDateHeaderRow(row) {
  // A row is a date header if:
  // - cell 0 contains a workout type label (like "Chest + Tris Workout", "Back & Legs Workout", "Back & Biceps")
  // - at least 2 of cells 1+ parse as dates
  const label = (row[0] || '').trim().toLowerCase();
  const isLabel = label.includes('workout') || label.includes('back & biceps') ||
                  label.includes('back & legs') || label.includes('chest');
  if (!isLabel) return false;

  let dateCount = 0;
  for (let c = 1; c < row.length && c < 15; c++) {
    const v = (row[c] || '').trim();
    if (v && parseDate(v)) dateCount++;
  }
  return dateCount >= 2;
}

function transposeSheet(csvRows, sheetName) {
  if (!csvRows || csvRows.length === 0) return { workouts: [], weights: [] };

  const workouts = [];
  const weights = [];

  // Find all section headers (rows that contain dates)
  const sections = [];
  for (let r = 0; r < csvRows.length; r++) {
    if (isDateHeaderRow(csvRows[r])) {
      sections.push(r);
    }
  }

  // If no section headers found, skip this sheet
  if (sections.length === 0) return { workouts: [], weights: [] };

  // Process each section
  for (let si = 0; si < sections.length; si++) {
    const headerRowIdx = sections[si];
    const nextSectionIdx = si + 1 < sections.length ? sections[si + 1] : csvRows.length;
    const headerRow = csvRows[headerRowIdx];
    const sectionLabel = (headerRow[0] || '').trim();

    // Parse dates from this header row
    const dates = [];
    for (let c = 1; c < headerRow.length; c++) {
      const raw = (headerRow[c] || '').trim();
      if (!raw) continue;
      // Skip "MOST RECENT" and similar
      if (/most recent/i.test(raw)) continue;
      const d = parseDate(raw);
      if (d) dates.push({ col: c, date: d });
    }

    if (dates.length === 0) continue;

    // Process exercise rows in this section
    for (let r = headerRowIdx + 1; r < nextSectionIdx; r++) {
      const row = csvRows[r];
      const exerciseName = (row[0] || '').trim();
      if (!exerciseName) continue;
      // Skip meta rows
      if (/^(note|http|abs.*circut|$)/i.test(exerciseName)) continue;

      const isWeight = /^weight$/i.test(exerciseName);

      for (const { col, date } of dates) {
        const cellVal = (row[col] || '').trim();
        if (!cellVal) continue;

        if (isWeight) {
          const w = parseWeightValue(cellVal);
          if (w !== null) {
            weights.push({ date, weight: w, sheetName });
          }
        } else {
          const parsed = parseWorkoutCell(cellVal);
          for (const p of parsed) {
            workouts.push({
              date,
              exercise: exerciseName,
              sets: p.sets,
              reps: p.reps,
              weight: p.weight,
              sheetName,
              sectionLabel,
              muscleGroup: classifyExercise(exerciseName),
            });
          }
        }
      }
    }
  }

  return { workouts, weights };
}

// ============================================================
// EXERCISE TECHNIQUE MODAL
// ============================================================
function getVideoEmbedUrl(videoId, platform) {
  if (platform === 'vimeo') {
    return `https://player.vimeo.com/video/${videoId}?badge=0&autopause=0&quality_selector=1`;
  }
  return `https://www.youtube.com/embed/${videoId}?rel=0`;
}

function openExerciseModal(exerciseName) {
  const ref = getExerciseReference(exerciseName);
  const modal = document.getElementById('exercise-modal');
  const title = document.getElementById('exercise-modal-title');
  const muscle = document.getElementById('exercise-modal-muscle');
  const video = document.getElementById('exercise-modal-video');
  const placeholder = document.getElementById('exercise-modal-video-placeholder');
  const equipment = document.getElementById('exercise-modal-equipment');
  const cues = document.getElementById('exercise-modal-cues');
  const mistakes = document.getElementById('exercise-modal-mistakes');

  if (ref) {
    title.textContent = ref.displayName;
    muscle.textContent = ref.muscleGroup;
    equipment.textContent = ref.equipment;
    cues.innerHTML = ref.cues.map(c => `<li>${c}</li>`).join('');
    mistakes.innerHTML = ref.common_mistakes.map(m => `<li>${m}</li>`).join('');

    if (ref.videoId) {
      video.src = getVideoEmbedUrl(ref.videoId, ref.videoPlatform);
      video.style.display = 'block';
      placeholder.style.display = 'none';
    } else {
      video.style.display = 'none';
      placeholder.style.display = 'flex';
    }
  } else {
    title.textContent = exerciseName;
    muscle.textContent = classifyExercise(exerciseName);
    equipment.textContent = 'Not specified';
    cues.innerHTML = '<li>No technique cues available for this exercise yet.</li>';
    mistakes.innerHTML = '';
    video.style.display = 'none';
    placeholder.style.display = 'flex';
  }

  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeExerciseModal() {
  const modal = document.getElementById('exercise-modal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  // Stop video playback by clearing src
  document.getElementById('exercise-modal-video').src = '';
}

// Close on backdrop click
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('exercise-modal-backdrop')) closeExerciseModal();
});

// Close on X button
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('exercise-modal-close')) closeExerciseModal();
});

// Close on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeExerciseModal();
});

// Delegated click handler for all exercise links
document.addEventListener('click', (e) => {
  const link = e.target.closest('.exercise-link[data-exercise-ref]');
  if (link) {
    e.preventDefault();
    e.stopPropagation();
    openExerciseModal(link.dataset.exerciseRef);
  }
});

// ============================================================
// COLLAPSIBLE LOG FORM
// ============================================================
document.getElementById('log-toggle').addEventListener('click', () => {
  const wrapper = document.getElementById('log-form-wrapper');
  const icon = document.getElementById('log-toggle-icon');
  wrapper.classList.toggle('open');
  icon.classList.toggle('open');
});

// ============================================================
// LOG WORKOUT FORM
// ============================================================
function initLogForm() {
  const typeSelect = document.getElementById('log-type');
  const dateInput = document.getElementById('log-date');
  const exercisesDiv = document.getElementById('log-exercises');
  const form = document.getElementById('log-form');
  const statusDiv = document.getElementById('log-status');
  const submitBtn = document.getElementById('log-submit');

  // Default date to today
  dateInput.value = new Date().toISOString().slice(0, 10);

  // Populate workout type dropdown
  for (const typeName of Object.keys(WORKOUT_TYPES)) {
    const opt = document.createElement('option');
    opt.value = typeName;
    opt.textContent = typeName;
    typeSelect.appendChild(opt);
  }

  // Render exercise inputs when type changes
  function renderExercises() {
    const exercises = WORKOUT_TYPES[typeSelect.value];
    if (!exercises) return;
    exercisesDiv.innerHTML = '';
    for (const name of exercises) {
      const row = document.createElement('div');
      row.className = 'log-exercise-row';
      row.innerHTML = `
        <label><span class="exercise-link" data-exercise-ref="${name}">${name}</span></label>
        <div class="log-exercise-inputs">
          <div class="log-exercise-field">
            <span class="field-label">Sets</span>
            <input type="number" data-exercise="${name}" data-field="sets"
                   placeholder="3" min="1" max="20" inputmode="numeric">
          </div>
          <div class="log-exercise-field">
            <span class="field-label">Reps</span>
            <input type="number" data-exercise="${name}" data-field="reps"
                   placeholder="10" min="1" max="100" inputmode="numeric">
          </div>
          <div class="log-exercise-field">
            <span class="field-label">Weight (kg)</span>
            <input type="number" data-exercise="${name}" data-field="weight"
                   placeholder="12.5" min="0" step="0.5" inputmode="decimal">
          </div>
          <button type="button" class="each-side-toggle" title="Each side">ES</button>
        </div>
      `;
      row.querySelector('.each-side-toggle').addEventListener('click', function() {
        this.classList.toggle('active');
      });
      exercisesDiv.appendChild(row);
    }
  }

  typeSelect.addEventListener('change', renderExercises);
  renderExercises();

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
      statusDiv.textContent = 'Set APPS_SCRIPT_URL in the source code first (see Code.gs setup instructions).';
      statusDiv.className = 'log-status error';
      return;
    }

    submitBtn.disabled = true;
    statusDiv.textContent = 'Submitting...';
    statusDiv.className = 'log-status';

    const typeName = typeSelect.value;
    const dateStr = dateInput.value;
    const dateObj = new Date(dateStr + 'T00:00:00');

    // Format date as "D Month YYYY" to match the sheet's convention
    const formattedDate = dateObj.toLocaleDateString('en-GB', {
      day: 'numeric', month: 'long', year: 'numeric'
    });

    const bodyWeight = document.getElementById('log-bodyweight').value.trim() || null;

    // Collect exercise values from structured inputs
    const exercises = [];
    const exerciseRows = exercisesDiv.querySelectorAll('.log-exercise-row');
    for (const row of exerciseRows) {
      const setsInput = row.querySelector('input[data-field="sets"]');
      const repsInput = row.querySelector('input[data-field="reps"]');
      const weightInput = row.querySelector('input[data-field="weight"]');
      const sets = setsInput.value.trim();
      const reps = repsInput.value.trim();
      const weight = weightInput.value.trim();
      // Skip if all empty
      if (!sets && !reps && !weight) continue;
      const name = setsInput.dataset.exercise;
      // Build the notation string: "3s of 10r @ 12.5kgs"
      let value = '';
      if (sets && reps && weight) {
        value = `${sets}s of ${reps}r @ ${weight}kgs`;
      } else if (sets && reps) {
        value = `${sets}s of ${reps}r`;
      } else if (reps && weight) {
        value = `1s of ${reps}r @ ${weight}kgs`;
      } else if (sets) {
        value = `${sets}s`;
      }
      const toggle = row.querySelector('.each-side-toggle');
      if (toggle && toggle.classList.contains('active')) {
        value += ' each side';
      }
      if (value) exercises.push({ name, value });
    }

    if (exercises.length === 0 && !bodyWeight) {
      statusDiv.textContent = 'Fill in at least one exercise or body weight.';
      statusDiv.className = 'log-status error';
      submitBtn.disabled = false;
      return;
    }

    const sheetTab = 'Workout ' + dateObj.getFullYear();

    const payload = {
      sheetTab,
      sectionLabel: typeName,
      date: formattedDate,
      bodyWeight,
      exercises,
    };

    try {
      const res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // text/plain avoids CORS preflight
        body: JSON.stringify(payload),
      });
      const result = await res.json();
      if (result.success) {
        statusDiv.textContent = 'Workout logged successfully!';
        statusDiv.className = 'log-status success';
        // Clear inputs but keep type and date
        exercisesDiv.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
        document.getElementById('log-bodyweight').value = '';
        exercisesDiv.querySelectorAll('.each-side-toggle').forEach(t => t.classList.remove('active'));
      } else {
        throw new Error(result.error || 'Unknown error');
      }
    } catch (err) {
      statusDiv.textContent = 'Error: ' + err.message;
      statusDiv.className = 'log-status error';
    }

    submitBtn.disabled = false;
  });
}

// ============================================================
// MAIN
// ============================================================
let allWorkouts = [];
let allWeights = [];
let exerciseChart = null;

async function main() {
  const loadingEl = document.getElementById('loading');
  const appEl = document.getElementById('app');

  try {
    const results = await Promise.all(SHEETS.map(async (name) => {
      const csv = await fetchSheet(name);
      return transposeSheet(csv, name);
    }));

    for (const r of results) {
      allWorkouts.push(...r.workouts);
      allWeights.push(...r.weights);
    }

    // Sort by date
    allWorkouts.sort((a, b) => a.date - b.date);
    allWeights.sort((a, b) => a.date - b.date);

    if (allWorkouts.length === 0) {
      loadingEl.innerHTML = '<div class="error-banner">No workout data found. Make sure the Google Sheet is published to the web (File → Share → Publish to web).</div>';
      return;
    }

    loadingEl.style.display = 'none';
    appEl.style.display = 'block';

    initLogForm();
    renderHeader();
    renderSummary();
    renderWeightChart();
    renderFrequencyChart();
    renderMuscleChart();
    renderExerciseProgress();
    renderRecommendations();

  } catch (err) {
    console.error(err);
    loadingEl.innerHTML = `<div class="error-banner">Error loading data: ${err.message}<br><br>Make sure the sheet is published to web and the sheet ID is correct.</div>`;
  }
}

// ============================================================
// HEADER
// ============================================================
function renderHeader() {
  const el = document.getElementById('header-stats');
  const uniqueDates = [...new Set(allWorkouts.map(w => w.date.toDateString()))].sort();
  const lastDate = allWorkouts[allWorkouts.length - 1].date;
  const daysSinceLast = Math.floor((new Date() - lastDate) / 86400000);

  // Calculate streak (consecutive weeks with at least 1 workout, going back from most recent)
  const weekSet = new Set();
  for (const w of allWorkouts) {
    const d = new Date(w.date);
    const weekStart = new Date(d);
    weekStart.setDate(d.getDate() - d.getDay());
    weekSet.add(weekStart.toDateString());
  }

  let streak = 0;
  const now = new Date();
  const checkWeek = new Date(now);
  checkWeek.setDate(now.getDate() - now.getDay());
  for (let i = 0; i < 200; i++) {
    if (weekSet.has(checkWeek.toDateString())) {
      streak++;
      checkWeek.setDate(checkWeek.getDate() - 7);
    } else {
      break;
    }
  }

  const fmt = d => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

  el.innerHTML = `
    <span class="header-stat">Last workout: <strong>${fmt(lastDate)}</strong> (${daysSinceLast === 0 ? 'today' : daysSinceLast + 'd ago'})</span>
    <span class="header-stat">Total sessions: <strong>${uniqueDates.length}</strong></span>
    ${streak > 1 ? `<span class="streak-badge">${streak} week streak</span>` : ''}
  `;
}

// ============================================================
// SUMMARY CARDS
// ============================================================
function renderSummary() {
  const el = document.getElementById('summary-grid');
  const uniqueDates = [...new Set(allWorkouts.map(w => w.date.toDateString()))];
  const exercises = [...new Set(allWorkouts.map(w => w.exercise))];

  // Latest weight
  const latestWeight = allWeights.length > 0 ? allWeights[allWeights.length - 1].weight : null;

  // Average sessions per week (last 8 weeks)
  const eightWeeksAgo = new Date(Date.now() - 56 * 86400000);
  const recentSessionDates = new Set(
    allWorkouts.filter(w => w.date >= eightWeeksAgo).map(w => w.date.toDateString())
  );
  const avgPerWeek = (recentSessionDates.size / 8).toFixed(1);

  el.innerHTML = `
    <div class="summary-item">
      <div class="value" data-countup="${uniqueDates.length}">0</div>
      <div class="label">Workouts</div>
    </div>
    <div class="summary-item">
      <div class="value" data-countup="${exercises.length}">0</div>
      <div class="label">Exercises</div>
    </div>
    <div class="summary-item">
      <div class="value" data-countup="${avgPerWeek}" data-decimals="1">0</div>
      <div class="label">Avg / Week</div>
    </div>
    <div class="summary-item">
      <div class="value" data-countup="${latestWeight || 0}" data-suffix="kg" data-decimals="1">0</div>
      <div class="label">Body Weight</div>
    </div>
  `;

  // Animate count-up
  el.querySelectorAll('[data-countup]').forEach(el => {
    const target = parseFloat(el.dataset.countup);
    if (!target) { el.textContent = '—'; return; }
    const decimals = parseInt(el.dataset.decimals) || 0;
    const suffix = el.dataset.suffix || '';
    const duration = 800;
    const start = performance.now();
    function tick(now) {
      const progress = Math.min((now - start) / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
      const current = (target * eased).toFixed(decimals);
      el.textContent = current + suffix;
      if (progress < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  });
}

// ============================================================
// CHART DEFAULTS
// ============================================================
const chartColors = {
  accent: '#6c9fff',
  accentBg: 'rgba(108,159,255,0.15)',
  secondary: '#bb86fc',
  secondaryBg: 'rgba(187,134,252,0.15)',
  green: '#34d399',
  greenBg: 'rgba(52,211,153,0.15)',
  orange: '#fb923c',
  orangeBg: 'rgba(251,146,60,0.15)',
  red: '#f87171',
  yellow: '#fbbf24',
  grid: 'rgba(255,255,255,0.06)',
  gridLabel: '#5f6368',
};

Chart.defaults.color = chartColors.gridLabel;
Chart.defaults.borderColor = chartColors.grid;
Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 16;
Chart.defaults.animation.duration = 600;

// ============================================================
// BODY WEIGHT CHART
// ============================================================
function renderWeightChart() {
  const ctx = document.getElementById('weightChart').getContext('2d');

  if (allWeights.length === 0) {
    ctx.canvas.parentElement.innerHTML = '<p class="no-data">No body weight data found</p>';
    return;
  }

  // Deduplicate by date (keep last entry per date)
  const byDate = new Map();
  for (const w of allWeights) {
    byDate.set(w.date.toDateString(), w);
  }
  const data = [...byDate.values()].sort((a, b) => a.date - b.date);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.date),
      datasets: [{
        label: 'Weight (kg)',
        data: data.map(d => d.weight),
        borderColor: chartColors.accent,
        backgroundColor: chartColors.accentBg,
        fill: true,
        tension: 0.3,
        pointRadius: 2,
        pointHoverRadius: 6,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth < 768 ? 1.4 : 2,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'month', tooltipFormat: 'dd MMM yyyy' },
          grid: { display: false },
        },
        y: {
          beginAtZero: false,
          grid: { color: chartColors.grid },
        }
      }
    }
  });
}

// ============================================================
// WORKOUT FREQUENCY CHART
// ============================================================
function renderFrequencyChart() {
  const ctx = document.getElementById('frequencyChart').getContext('2d');

  // Group workouts by ISO week
  const weekMap = new Map();
  for (const w of allWorkouts) {
    const d = new Date(w.date);
    const weekStart = new Date(d);
    weekStart.setDate(d.getDate() - ((d.getDay() + 6) % 7)); // Monday start
    weekStart.setHours(0, 0, 0, 0);
    const key = weekStart.toISOString().slice(0, 10);
    if (!weekMap.has(key)) weekMap.set(key, new Set());
    weekMap.get(key).add(w.date.toDateString());
  }

  const weeks = [...weekMap.entries()]
    .map(([key, dates]) => ({ date: new Date(key), count: dates.size }))
    .sort((a, b) => a.date - b.date);

  // Show only last 52 weeks for readability, or all if fewer
  const displayWeeks = weeks.length > 52 ? weeks.slice(-52) : weeks;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: displayWeeks.map(w => w.date),
      datasets: [{
        label: 'Sessions / week',
        data: displayWeeks.map(w => w.count),
        backgroundColor: displayWeeks.map(w =>
          w.count >= 3 ? chartColors.green :
          w.count >= 2 ? chartColors.accent :
          w.count >= 1 ? chartColors.orange :
          chartColors.red
        ),
        borderRadius: 3,
        barPercentage: 0.85,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth < 768 ? 1.4 : 2,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'month', tooltipFormat: 'dd MMM yyyy' },
          grid: { display: false },
        },
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          grid: { color: chartColors.grid },
        }
      }
    }
  });
}

// ============================================================
// MUSCLE GROUP BALANCE — Radar chart
// ============================================================
function renderMuscleChart() {
  const ctx = document.getElementById('muscleChart').getContext('2d');

  const groupVolume = {};
  for (const w of allWorkouts) {
    const g = w.muscleGroup;
    if (g === 'Other') continue;
    groupVolume[g] = (groupVolume[g] || 0) + w.sets * w.reps;
  }

  const labels = Object.keys(groupVolume).sort();
  const data = labels.map(l => groupVolume[l]);

  if (labels.length === 0) {
    ctx.canvas.parentElement.innerHTML = '<p class="no-data">No muscle group data</p>';
    return;
  }

  new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: 'Total Sets × Reps',
        data,
        borderColor: chartColors.accent,
        backgroundColor: chartColors.accentBg,
        borderWidth: 2,
        pointBackgroundColor: chartColors.accent,
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth < 768 ? 1 : 1.3,
      plugins: { legend: { display: false } },
      scales: {
        r: {
          beginAtZero: true,
          grid: { color: chartColors.grid },
          angleLines: { color: chartColors.grid },
          pointLabels: { color: chartColors.gridLabel, font: { size: 12 } },
          ticks: { display: false },
        }
      }
    }
  });
}

// ============================================================
// EXERCISE PROGRESS
// ============================================================
function renderExerciseProgress() {
  const select = document.getElementById('exercise-select');
  const ctx = document.getElementById('exerciseChart').getContext('2d');

  // Group exercises by muscle group
  const exercisesByGroup = {};
  for (const w of allWorkouts) {
    const group = w.muscleGroup || 'Other';
    if (!exercisesByGroup[group]) exercisesByGroup[group] = new Set();
    exercisesByGroup[group].add(w.exercise);
  }

  // Sort groups in a logical order, then alphabetically within each
  const groupOrder = ['Chest', 'Triceps', 'Shoulders', 'Back', 'Biceps', 'Legs', 'Core', 'Other'];
  const sortedGroups = Object.keys(exercisesByGroup).sort((a, b) => {
    const ai = groupOrder.indexOf(a), bi = groupOrder.indexOf(b);
    return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
  });

  const exercises = [];
  for (const group of sortedGroups) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = group;
    const sorted = [...exercisesByGroup[group]].sort();
    for (const ex of sorted) {
      exercises.push(ex);
      const opt = document.createElement('option');
      opt.value = ex;
      opt.textContent = ex;
      optgroup.appendChild(opt);
    }
    select.appendChild(optgroup);
  }

  function renderChart(exerciseName) {
    const entries = allWorkouts.filter(w => w.exercise === exerciseName && w.weight > 0);

    // Group by date — take max weight per date
    const byDate = new Map();
    for (const e of entries) {
      const key = e.date.toDateString();
      const existing = byDate.get(key);
      if (!existing || e.weight > existing.weight) {
        byDate.set(key, e);
      }
    }

    const data = [...byDate.values()].sort((a, b) => a.date - b.date);

    if (exerciseChart) exerciseChart.destroy();

    if (data.length === 0) {
      exerciseChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ data: [] }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
      return;
    }

    exerciseChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => d.date),
        datasets: [{
          label: exerciseName + ' (kg)',
          data: data.map(d => d.weight),
          borderColor: chartColors.green,
          backgroundColor: chartColors.greenBg,
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 7,
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: window.innerWidth < 768 ? 1.4 : 1.8,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'month', tooltipFormat: 'dd MMM yyyy' },
            grid: { display: false },
          },
          y: {
            beginAtZero: false,
            grid: { color: chartColors.grid },
            title: { display: true, text: 'Weight (kg)', color: chartColors.gridLabel },
          }
        }
      }
    });
  }

  if (exercises.length > 0) renderChart(exercises[0]);
  select.addEventListener('change', () => renderChart(select.value));

  document.getElementById('exercise-info-btn').addEventListener('click', () => {
    openExerciseModal(select.value);
  });
}

// ============================================================
// TRAINING RECOMMENDATIONS
// ============================================================
function renderRecommendations() {
  const el = document.getElementById('recommendations');
  const recs = [];

  // 1. Days since each workout type (by section label, e.g. "Chest + Tris Workout", "Back & Biceps")
  const typeLastDate = {};
  for (const w of allWorkouts) {
    const key = (w.sectionLabel || w.sheetName || '').replace(/\s*workout\s*/i, '').trim();
    if (!key) continue;
    if (!typeLastDate[key] || w.date > typeLastDate[key]) {
      typeLastDate[key] = w.date;
    }
  }

  const now = new Date();
  let suggestType = null;
  let maxDays = 0;
  for (const [type, date] of Object.entries(typeLastDate)) {
    const days = Math.floor((now - date) / 86400000);
    if (days > maxDays) {
      maxDays = days;
      suggestType = type;
    }
  }

  if (suggestType && maxDays > 3) {
    recs.push({
      icon: 'warn',
      text: `It's been <strong>${maxDays} days</strong> since your last <strong>${suggestType}</strong> session. Consider training that next.`,
    });
  }

  // 2. Muscle group imbalance
  const groupSets = {};
  // Only look at last 30 days for recent balance
  const thirtyDaysAgo = new Date(now - 30 * 86400000);
  for (const w of allWorkouts) {
    if (w.date < thirtyDaysAgo) continue;
    const g = w.muscleGroup;
    if (g === 'Other') continue;
    groupSets[g] = (groupSets[g] || 0) + w.sets;
  }

  const groups = Object.entries(groupSets).sort((a, b) => a[1] - b[1]);
  if (groups.length >= 2) {
    const least = groups[0];
    const most = groups[groups.length - 1];
    if (most[1] > 0 && least[1] / most[1] < 0.4) {
      recs.push({
        icon: 'info',
        text: `<strong>${least[0]}</strong> is undertrained recently (${least[1]} sets) compared to <strong>${most[0]}</strong> (${most[1]} sets). Try adding more ${least[0].toLowerCase()} work.`,
      });
    }
  }

  // 3. Consistency check
  const fourWeeksAgo = new Date(now - 28 * 86400000);
  const recentDates = new Set(
    allWorkouts.filter(w => w.date >= fourWeeksAgo).map(w => w.date.toDateString())
  );
  const weeklyAvg = recentDates.size / 4;
  if (weeklyAvg < 2) {
    recs.push({
      icon: 'warn',
      text: `You've averaged <strong>${weeklyAvg.toFixed(1)} sessions/week</strong> over the last 4 weeks. Try to aim for at least 2-3 sessions per week.`,
    });
  } else if (weeklyAvg >= 3) {
    recs.push({
      icon: 'good',
      text: `Great consistency! <strong>${weeklyAvg.toFixed(1)} sessions/week</strong> over the last 4 weeks.`,
    });
  }

  // 4. PR check — find exercises where most recent session matched or exceeded all-time max
  const exerciseMax = {};
  const exerciseRecent = {};
  for (const w of allWorkouts) {
    if (w.weight <= 0) continue;
    if (!exerciseMax[w.exercise] || w.weight > exerciseMax[w.exercise]) {
      exerciseMax[w.exercise] = w.weight;
    }
  }
  const sevenDaysAgo = new Date(now - 7 * 86400000);
  for (const w of allWorkouts) {
    if (w.date < sevenDaysAgo || w.weight <= 0) continue;
    if (!exerciseRecent[w.exercise] || w.weight > exerciseRecent[w.exercise]) {
      exerciseRecent[w.exercise] = w.weight;
    }
  }
  const prs = [];
  for (const [ex, maxW] of Object.entries(exerciseRecent)) {
    if (maxW >= exerciseMax[ex]) prs.push(ex);
  }
  if (prs.length > 0) {
    recs.push({
      icon: 'good',
      text: `Recent PRs: <strong>${prs.slice(0, 3).map(ex => `<span class="exercise-link" data-exercise-ref="${ex}">${ex}</span>`).join(', ')}</strong>${prs.length > 3 ? ` and ${prs.length - 3} more` : ''}!`,
    });
  }

  // 5. If no recommendations, add a default
  if (recs.length === 0) {
    recs.push({
      icon: 'info',
      text: 'Keep up the good work! No specific recommendations right now.',
    });
  }

  el.innerHTML = recs.map(r => `
    <div class="rec-item">
      <div class="rec-icon ${r.icon}">${r.icon === 'warn' ? '!' : r.icon === 'good' ? '\u2713' : 'i'}</div>
      <div>${r.text}</div>
    </div>
  `).join('');
}

// ============================================================
// BOOT
// ============================================================
main();
</script>
</body>
</html>
